release-branches: &release-branches
  filters:
    tags:
      ignore: /.*/
    branches:
      only: /^release\/.*/

release-tags: &release-tags
  filters: 
    tags:
      ignore: /^.*-SNAPSHOT/
    branches:
      ignore: /.*/


version: 2.1
commands:
  install-gems:
    steps:
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}

      - run: bundle config set clean 'true'      
      
      - run: bundle config set path 'vendor/bundle'
      
      - run: bundle install
      
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

  trust-github-key:
    steps:
      - run:
          name: Trust GitHub key
          command: |
              for ip in $(dig @8.8.8.8 github.com +short); \
              do ssh-keyscan github.com,$ip; \
              ssh-keyscan $ip; \
              done 2>/dev/null >> ~/.ssh/known_hosts


jobs:

  deployment-checks: 
    macos:
      xcode: "12.2.0"
    working_directory: ~/revenuex-ios-sdk
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - trust-github-key


      
      - run:
          name: Deployment checks
          command: bundle exec fastlane deployment_checks
          
  
  make-release:
    macos:
      xcode: "12.2.0"
    working_directory: ~/revenuex-ios-sdk/
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - trust-github-key
      - run:
          name: Deploy new version
          command: bundle exec fastlane deploy

  prepare-next-version:
    macos:
      xcode: "12.2.0"
    working_directory: ~/revenuex-ios-sdk/
    shell: /bin/bash --login -o pipefail
    steps:
      - install-gems
      - checkout
      - trust-github-key
      - run:
          name: Prepare next version
          command: bundle exec fastlane prepare_next_version


workflows:
  version: 2
  build-test:
    jobs:
      - deployment-checks: *release-tags
  deploy:
    jobs:
      - make-release: *release-branches
      - prepare-next-version: *release-branches
